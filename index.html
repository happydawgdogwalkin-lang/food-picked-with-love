<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üçé Food Picked With Love Harvest Map</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0;padding:20px;background:#f8f9fa}
  .header{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);text-align:center;margin-bottom:20px}
  #mapContainer{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  #map{height:620px;border-radius:8px;border:2px solid #e9ecef}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  select, input, button{padding:8px 12px;border:2px solid #ddd;border-radius:6px;background:#fff}
  button.primary{background:#28a745;color:#fff;border-color:#28a745;cursor:pointer;font-weight:700}
  .legend{background:#fff;border-radius:10px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin:20px 0}
  .legend-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
  .legend-item{display:flex;align-items:center;gap:8px}
  .legend-color{width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}
  .list{background:#fff;border-radius:10px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.08);max-height:420px;overflow:auto;margin-top:20px}
  .item{padding:10px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;cursor:pointer;display:flex;gap:10px;justify-content:space-between;align-items:start}
  .item:hover{background:#f8f9fa;border-color:#28a745}
  .item .meta{flex:1}
  .pill{background:#e8f5e8;border:1px solid #28a745;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px;color:#2d5016}
  .pill-grey{background:#eef1f4;border:1px solid #c9d1d9;color:#334155}
  .approx{color:#a33;font-size:12px;margin-top:6px}
  .danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .form{display:none;background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin:12px 0}
  .form .row > *{flex:1 1 180px}
  .small{font-size:12px;color:#666}
</style>
</head>
<body>
  <div class="header">
    <h1>üçé Food Picked With Love Harvest Map</h1>
  </div>

  <div class="legend">
    <h4>Fruit Legend</h4>
    <div id="legendGrid" class="legend-grid"></div>
  </div>

  <div id="mapContainer">
    <div class="controls">
      <label>Fruit:
        <select id="fruitFilter"><option value="">All Fruits</option></select>
      </label>
      <label>City:
        <select id="cityFilter"><option value="">All Cities</option></select>
      </label>
      <label>Visited:
        <select id="visitFilter">
          <option value="">Any</option>
          <option value="2024">Visited in 2024</option>
          <option value="2023plus">Visited 2023+</option>
          <option value="never">Never set</option>
        </select>
      </label>
      <button id="toggleFormBtn" class="primary">+ Add Location</button>
      <span id="status" class="small"></span>
    </div>

    <div id="addForm" class="form">
      <div class="row">
        <input id="fAddress" placeholder="Address" />
        <input id="fCity" placeholder="City" />
        <input id="fState" placeholder="State" value="CA" />
        <input id="fZip" placeholder="ZIP" />
      </div>
      <div class="row">
        <input id="fFruits" placeholder="Fruits codes (e.g. L/O or NONE)" />
        <input id="fLastVisit" placeholder="Last visit (e.g. 5/5/2024 or Dec 4, 2022)" />
      </div>
      <div class="row">
        <input id="fLat" placeholder="Latitude (optional)" />
        <input id="fLng" placeholder="Longitude (optional)" />
      </div>
      <div class="row">
        <button id="addBtn" class="primary">Add</button>
        <button id="cancelEditBtn" style="display:none">Cancel</button>
        <span class="small" id="formHint">Tip: leave lat/lng empty to place at city center (approx).</span>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <div class="list">
    <h3 style="margin:0 0 10px 0">All Fruit Tree Locations</h3>
    <div id="locationsList"></div>
  </div>

  <!-- Maps JS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCBJSkTXJqZ9RWe2dEdweKvZtejQwfSXV8"></script>

  <script>
    // ======== Backend config ========
    // Be sure this matches your latest Deployment URL
    const API_URL   = 'https://script.google.com/macros/s/AKfycbwLKik53rZ1NC3Bt6N-CMPTdKLoKJDLOnZAiIjlzpTHERR1ITYpgX823ubr76D7FuTxBg/exec';
    const API_TOKEN = 'x7e8y9z-secret-4839asdlfkj2394'; // must match Script Properties TOKEN exactly

    // ======== Map config ========
    const fruitMappings = {
      L:'Lemons', O:'Oranges', T:'Tangerines', G:'Grapefruit', P:'Plums',
      A:'Apples', PE:'Peaches', PR:'Pears', FB:'Fava Beans', LQ:'Loquat',
      NONE:'No Fruit'
    };
    const fruitColors = {
      L:'#FFD700', O:'#FF8C00', T:'#FF4500', G:'#FFB6C1', P:'#9370DB',
      A:'#FF0000', PE:'#FFCBA4', PR:'#90EE90', FB:'#8FBC8F', LQ:'#DDA0DD',
      NONE:'#555555'
    };
    const FALLBACK_CENTER = {lat:37.906038, lng:-122.544976};

    // ======== State ========
    let locations = [];
    let map, markers = [];
    let formMode = 'add'; // 'add' | 'edit'
    let editId = null;

    const $ = sel => document.querySelector(sel);
    const setStatus = (msg) => { const n = $('#status'); if (n) n.textContent = msg || ''; };

    // ======== Utils ========
    function normalizeCoords(c){
      if(!c && c!==0) return null;
      if (typeof c==='object' && 'lat' in c) return {lat:+c.lat, lng:+c.lng};
      if (Array.isArray(c)) return {lat:+c[0], lng:+c[1]};
      if (typeof c==='string' && c.includes(',')){const [lat,lng]=c.split(',').map(Number); return {lat,lng};}
      return null;
    }
    function parseLastVisit(s){ if(!s) return null; const d=new Date(s); return isNaN(d)?null:d; }
    function fmtDate(d){ if(!d) return ''; return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`; }
    function relativeDays(d){
      if(!d) return null; const days=Math.floor((Date.now()-d.getTime())/86400000);
      if(days<1) return 'today'; if(days===1) return '1 day ago'; if(days<30) return `${days} days ago`;
      const m=Math.floor(days/30); if(m<12) return `${m} mo ago`; const y=Math.floor(days/365); return `${y} yr${y>1?'s':''} ago`;
    }
    function toFruitList(str){
      const arr = (str ? str.split(/[\/,-]/).map(f=>f.trim().toUpperCase()).filter(Boolean) : []);
      return arr.length ? arr : ['NONE'];
    }

    // ======== Backend calls (form-encoded to avoid CORS preflight) ========
    async function apiGetAll(){
      const url = `${API_URL}?token=${encodeURIComponent(API_TOKEN)}`;
      const r = await fetch(url, { method:'GET' });
      const raw = await r.text();
      try {
        const j = JSON.parse(raw);
        if(!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);
        return j.data;
      } catch(e){
        console.error('GET response:', raw);
        throw e;
      }
    }

    async function apiUpsert(record){
      const params = new URLSearchParams();
      params.set('token', API_TOKEN);
      params.set('action', 'upsert');
      params.set('record', JSON.stringify(record));

      const r = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });
      const raw = await r.text();
      let j;
      try { j = JSON.parse(raw); } catch { throw new Error(`Server returned non-JSON (${r.status}): ${raw.slice(0,160)}`); }
      if(!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);
      return j.id;
    }

    async function apiDelete(id){
      const params = new URLSearchParams();
      params.set('token', API_TOKEN);
      params.set('action', 'delete');
      params.set('id', String(id));

      const r = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });
      const raw = await r.text();
      let j;
      try { j = JSON.parse(raw); } catch { throw new Error(`Server returned non-JSON (${r.status}): ${raw.slice(0,160)}`); }
      if(!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);
      return j.deleted;
    }

    // ======== Normalize data from backend ========
    function normalizeRecords(rows){
      return rows.map(rec=>{
        const lastVisitDate = parseLastVisit(rec.lastVisit);
        const fixedId = (rec.id !== undefined && rec.id !== null) ? String(rec.id) : Math.random().toString(36).slice(2,11);
        return {
          id: fixedId,
          address: rec.address || '',
          city: rec.city || '',
          state: rec.state || '',
          zip: rec.zip || '',
          fruits: rec.fruits || '',
          fruitList: toFruitList(rec.fruits),
          coords: normalizeCoords((rec.lat!==undefined && rec.lng!==undefined && rec.lat!=='' && rec.lng!=='') ? {lat:rec.lat,lng:rec.lng} : null),
          lastVisit: rec.lastVisit || '',
          lastVisitDate,
          lastVisitYear: lastVisitDate ? lastVisitDate.getFullYear() : null
        };
      });
    }

    // ======== UI ========
    function drawLegend(){
      const grid = $('#legendGrid');
      grid.innerHTML = '';
      const ordered = Object.entries(fruitMappings).sort(([a],[b])=>{
        if(a==='NONE') return 1; if(b==='NONE') return -1; return a.localeCompare(b);
      });
      ordered.forEach(([code,name])=>{
        const color = fruitColors[code] || '#28a745';
        grid.insertAdjacentHTML('beforeend', `
          <div class="legend-item">
            <div class="legend-color" style="background:${color}"></div>
            <span><strong>${code}</strong> = ${name}</span>
          </div>`);
      });
    }

    function populateFilters(){
      const fruitSel = $('#fruitFilter');
      const citySel  = $('#cityFilter');
      const fruitSet = new Set(), citySet = new Set();
      locations.forEach(l => { l.fruitList.forEach(f=>fruitSet.add(f)); if(l.city) citySet.add(l.city); });
      fruitSet.add('NONE');
      fruitSel.innerHTML = '<option value="">All Fruits</option>';
      [...Array.from(fruitSet).sort((a,b)=> (a==='NONE')?1:(b==='NONE')?-1:a.localeCompare(b))]
        .forEach(f => fruitSel.insertAdjacentHTML('beforeend', `<option value="${f}">${fruitMappings[f]||f}</option>`));
      citySel.innerHTML = '<option value="">All Cities</option>';
      [...citySet].sort().forEach(c => citySel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
    }

    function renderList(){
      const container = $('#locationsList');
      const fruitF = $('#fruitFilter').value;
      const cityF  = $('#cityFilter').value;
      const visitF = $('#visitFilter').value;
      container.innerHTML = '';

      const filtered = locations.filter(l=>{
        if(fruitF && !l.fruitList.includes(fruitF)) return false;
        if(cityF && l.city !== cityF) return false;
        if(visitF === '2024' && l.lastVisitYear !== 2024) return false;
        if(visitF === '2023plus' && (!l.lastVisitYear || l.lastVisitYear < 2023)) return false;
        if(visitF === 'never' && l.lastVisitYear !== null) return false;
        return true;
      }).sort((a,b)=>{
        const ta = a.lastVisitDate ? a.lastVisitDate.getTime() : 0;
        const tb = b.lastVisitDate ? b.lastVisitDate.getTime() : 0;
        if(tb !== ta) return tb - ta;
        return (a.address||'').localeCompare((b.address||''));
      });

      filtered.forEach(l=>{
        const fruitTags = l.fruitList.map(f=>`<span class="pill">${fruitMappings[f]||f}</span>`).join(' ');
        const approx = l.coords ? '' : `<div class="approx">No coordinates yet ‚Äî showing at city center. Paste lat/lng into code to pin the exact house.</div>`;
        const last = l.lastVisitDate ? `<span class="pill pill-grey">Last visit: ${fmtDate(l.lastVisitDate)} ‚Ä¢ ${relativeDays(l.lastVisitDate)}</span>` : `<span class="pill pill-grey">Last visit: ‚Äî</span>`;
        container.insertAdjacentHTML('beforeend', `
          <div class="item" onclick="panTo('${String(l.id)}')">
            <div class="meta">
              <div style="font-weight:700;color:#2d5016">${l.address}</div>
              <div style="color:#666">${l.city}${l.zip?`, CA ${l.zip}`:', CA'}</div>
              <div style="margin-top:6px">${fruitTags || '<span class="pill">No fruits recorded</span>'}</div>
              <div style="margin-top:6px">${last}</div>
              ${approx}
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="event.stopPropagation(); onEdit('${String(l.id)}')">Edit</button>
              <button class="danger" onclick="event.stopPropagation(); onDelete('${String(l.id)}')">Delete</button>
            </div>
          </div>
        `);
      });
    }

    function buildInfoContent(l){
      const visitLine = l.lastVisitDate
        ? `<div class="pill pill-grey" style="display:inline-block;margin-top:6px">Last visit: ${fmtDate(l.lastVisitDate)} ‚Ä¢ ${relativeDays(l.lastVisitDate)}</div>`
        : `<div style="color:#777;margin-top:6px">Last visit: ‚Äî</div>`;
      return `
        <div style="max-width:260px">
          <h4 style="margin:0 0 8px;color:#2d5016">${l.address}</h4>
          <div style="font-size:14px;color:#555">${l.city}${l.zip?`, CA ${l.zip}`:', CA'}</div>
          <div style="margin:8px 0">${(l.fruitList.map(f=>`<span class='pill'>${fruitMappings[f]||f}</span>`).join(' ') || '<span style="color:#666">No fruits recorded</span>')}</div>
          ${visitLine}
          ${l.coords ? '' : '<div class="approx" style="margin-top:6px">Approximate (city center). Add exact lat/lng for a perfect pin.</div>'}
        </div>`;
    }

    function addAllMarkers(){
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(m => m.marker.setMap(null));
      markers = [];
      const now = Date.now();

      locations.forEach(l=>{
        const pos = l.coords || FALLBACK_CENTER;
        const primary = l.fruitList[0] || 'NONE';
        const color = fruitColors[primary] || '#555555';
        const recent = l.lastVisitDate ? (now - l.lastVisitDate.getTime()) <= 365*24*60*60*1000 : false;

        const marker = new google.maps.Marker({
          position:pos, map,
          icon:{ path:google.maps.SymbolPath.CIRCLE, scale: recent?10:8, fillColor:color, fillOpacity:1, strokeColor: recent?'#1f6feb':'#fff', strokeWeight: recent?3:2 },
          title:l.address, zIndex: l.coords ? 100 : 50
        });
        const iw = new google.maps.InfoWindow({ content: buildInfoContent(l) });
        marker.addListener('click', ()=> iw.open(map, marker));
        markers.push({id:String(l.id), marker, location:l, infowin: iw});
        bounds.extend(marker.getPosition());
      });

      if(!bounds.isEmpty()) map.fitBounds(bounds, { padding:{top:40,right:40,bottom:40,left:40} });
    }

    function applyFilters(){
      renderList();
      const fruitF = $('#fruitFilter').value;
      const cityF  = $('#cityFilter').value;
      const visitF = $('#visitFilter').value;

      const b = new google.maps.LatLngBounds(); let any=false;
      markers.forEach(({marker, location})=>{
        let show = true;
        if(fruitF && !location.fruitList.includes(fruitF)) show = false;
        if(cityF && location.city !== cityF) show = false;
        if(visitF === '2024' && location.lastVisitYear !== 2024) show = false;
        if(visitF === '2023plus' && (!location.lastVisitYear || location.lastVisitYear < 2023)) show = false;
        if(visitF === 'never' && location.lastVisitYear !== null) show = false;
        marker.setVisible(show);
        if(show){ b.extend(marker.getPosition()); any = true; }
      });
      if(any) map.fitBounds(b, { padding:{top:40,right:40,bottom:40,left:40} });
    }

    function panTo(id){
      const found = markers.find(m=>m.id===String(id));
      if(found){
        map.panTo(found.marker.getPosition());
        map.setZoom(Math.max(map.getZoom(), 15));
        google.maps.event.trigger(found.marker, 'click');
      }
    }

    // ======== Add/Edit/Delete handlers (with backend) ========
    function setFormMode(mode){
      formMode = mode; // 'add' or 'edit'
      const addBtn = $('#addBtn');
      const cancelBtn = $('#cancelEditBtn');
      const hint = $('#formHint');
      if(mode === 'edit'){
        addBtn.textContent = 'Save';
        cancelBtn.style.display = 'inline-block';
        hint.textContent = 'Editing existing location. Update fields and click Save.';
      } else {
        addBtn.textContent = 'Add';
        cancelBtn.style.display = 'none';
        hint.textContent = 'Tip: leave lat/lng empty to place at city center (approx).';
        editId = null;
      }
    }

    function fillFormFrom(rec){
      $('#fAddress').value = rec.address || '';
      $('#fCity').value = rec.city || '';
      $('#fState').value = rec.state || 'CA';
      $('#fZip').value = rec.zip || '';
      $('#fFruits').value = rec.fruits || '';
      $('#fLastVisit').value = rec.lastVisit || '';
      $('#fLat').value = rec.coords ? String(rec.coords.lat) : '';
      $('#fLng').value = rec.coords ? String(rec.coords.lng) : '';
    }

    function clearForm(){
      ['#fAddress','#fCity','#fState','#fZip','#fFruits','#fLastVisit','#fLat','#fLng'].forEach(s=>$(s).value='');
    }

    function buildRecordFromForm(){
      const addr = $('#fAddress').value.trim();
      const city = $('#fCity').value.trim();
      const state= $('#fState').value.trim() || 'CA';
      const zip  = $('#fZip').value.trim();
      const fruitsStr = $('#fFruits').value.trim();
      const lastVisit = $('#fLastVisit').value.trim();
      const latStr = $('#fLat').value.trim();
      const lngStr = $('#fLng').value.trim();

      if(!addr || !city){ throw new Error('Please provide at least Address and City.'); }

      const record = {
        id: (formMode === 'edit' && editId) ? String(editId) : Math.random().toString(36).slice(2,11),
        address: addr,
        city, state, zip,
        fruits: fruitsStr,
        lastVisit: lastVisit || ''
      };

      const latNum = Number(latStr);
      const lngNum = Number(lngStr);
      if(Number.isFinite(latNum) && Number.isFinite(lngNum)){
        record.lat = latNum;
        record.lng = lngNum;
      }

      return record;
    }

    async function onSave(){
      let rec;
      try{
        rec = buildRecordFromForm();
      }catch(e){
        alert(e.message);
        return;
      }
      try{
        setStatus(formMode === 'edit' ? 'Saving changes‚Ä¶' : 'Saving‚Ä¶');
        await apiUpsert(rec);
        await reloadFromBackend();
        $('#addForm').style.display='none';
        clearForm();
        setFormMode('add');
        setStatus('Saved.');
      }catch(e){
        console.error(e);
        setStatus('Save failed.');
        alert('Error saving to server: ' + e.message);
      }
    }

    function onEdit(id){
      const rec = locations.find(l => String(l.id) === String(id));
      if(!rec){ alert('Record not found.'); return; }
      editId = String(id);
      fillFormFrom(rec);
      setFormMode('edit');
      $('#addForm').style.display='block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function onAdd(){ await onSave(); }

    async function onDelete(id){
      if(!confirm('Delete this location?')) return;
      try{
        setStatus('Deleting‚Ä¶');
        await apiDelete(String(id));
        await reloadFromBackend();
        setStatus('Deleted.');
      }catch(e){
        console.error(e); setStatus('Delete failed.');
        alert('Error deleting on server: ' + e.message);
      }
    }

    async function reloadFromBackend(){
      setStatus('Loading‚Ä¶');
      const rows = await apiGetAll();
      locations = normalizeRecords(rows);
      drawLegend();
      populateFilters();
      renderList();
      addAllMarkers();
      applyFilters();
      setStatus('');
    }

    // ======== Boot ========
    async function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: FALLBACK_CENTER, zoom: 12, mapTypeId: 'roadmap'
      });
      drawLegend();
      $('#fruitFilter').addEventListener('change', applyFilters);
      $('#cityFilter').addEventListener('change', applyFilters);
      $('#visitFilter').addEventListener('change', applyFilters);
      $('#toggleFormBtn').addEventListener('click', () => {
        const f = $('#addForm');
        if(f.style.display === 'none' || !f.style.display){
          f.style.display = 'block';
          setFormMode('add');
          clearForm();
        } else {
          f.style.display = 'none';
        }
      });
      $('#addBtn').addEventListener('click', onSave);
      $('#cancelEditBtn').addEventListener('click', () => {
        clearForm();
        setFormMode('add');
        $('#addForm').style.display='none';
      });
      await reloadFromBackend();
    }

    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
